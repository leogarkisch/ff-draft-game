{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                <h2 class="mb-0">üîß Admin Panel</h2>
                <a href="{{ url_for('admin_logout') }}" class="btn btn-outline-light btn-sm">Logout</a>
            </div>
            <div class="card-body">
                <!-- Initialization Status -->
                <div class="alert {% if game_state and game_state.is_initialized %}alert-success{% else %}alert-warning{% endif %}">
                    <h4>üöÄ Game Initialization</h4>
                    {% if game_state and game_state.is_initialized %}
                        <p><strong>‚úÖ Game Initialized</strong></p>
                        <p><strong>League:</strong> {{ game_state.league_name or 'Fantasy Football League' }}</p>
                        <p><strong>Teams:</strong> {{ game_state.num_teams }}</p>
                        <p><strong>Mode:</strong> 
                            <span class="badge {% if game_state.is_simulation %}bg-info{% else %}bg-success{% endif %}">
                                {% if game_state.is_simulation %}Simulation{% else %}Real Draft{% endif %}
                            </span>
                        </p>
                        <p><strong>Dev Mode:</strong> 
                            <span class="badge {% if game_state.dev_mode %}bg-warning{% else %}bg-secondary{% endif %}">
                                {% if game_state.dev_mode %}Enabled{% else %}Disabled{% endif %}
                            </span>
                        </p>
                        <p><strong>Submission Deadline:</strong> 
                            {% if game_state.submission_deadline %}
                                <span class="badge bg-warning">{{ game_state.submission_deadline.astimezone(pytz.timezone('US/Eastern')).strftime('%m/%d %I:%M %p ET') }}</span>
                            {% else %}
                                <span class="badge bg-secondary">No deadline set</span>
                            {% endif %}
                        </p>
                        <div class="mt-2">
                            <form method="POST" action="{{ url_for('admin_reset_to_setup') }}" class="inline-form">
                                <button type="submit" class="btn btn-warning" 
                                        onclick="return confirm('This will reset the game to setup phase. All current data will be lost. Continue?')">
                                    Reset to Setup
                                </button>
                            </form>
                        </div>
                    {% else %}
                        <p><strong>‚ö†Ô∏è Game Not Initialized</strong></p>
                        <p>Use the form below to initialize the game with all settings:</p>
                        
                        <!-- Game Initialization Form -->
                        <form method="POST" action="{{ url_for('admin_initialize_game') }}" class="border p-3 bg-light rounded">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="league_name" class="form-label">League Name</label>
                                    <input type="text" class="form-control" id="league_name" name="league_name" 
                                           value="{{ game_state.league_name if game_state and game_state.league_name else 'Fantasy Football League' }}" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="num_teams" class="form-label">Number of Teams</label>
                                    <select class="form-control" id="num_teams" name="num_teams" required>
                                        {% for i in range(2, 21) %}
                                            <option value="{{ i }}" {% if game_state and game_state.num_teams == i %}selected{% elif i == 12 %}selected{% endif %}>{{ i }} teams</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="is_simulation" name="is_simulation" 
                                               {% if game_state and game_state.is_simulation %}checked{% endif %}>
                                        <label class="form-check-label" for="is_simulation">
                                            Simulation Mode (test run)
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="dev_mode" name="dev_mode" 
                                               {% if game_state and game_state.dev_mode %}checked{% endif %}>
                                        <label class="form-check-label" for="dev_mode">
                                            Developer Mode
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="deadline_date" class="form-label">Submission Deadline (Optional)</label>
                                    <input type="date" class="form-control" id="deadline_date" name="deadline_date">
                                    <small class="text-muted">Leave blank for no deadline</small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="deadline_time" class="form-label">Time (ET)</label>
                                    <input type="time" class="form-control" id="deadline_time" name="deadline_time" value="18:00">
                                    <small class="text-muted">Defaults to 6:00 PM ET</small>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-success btn-lg">
                                üöÄ Initialize Game
                            </button>
                        </form>
                    {% endif %}
                </div>

                <!-- Game State Controls -->
                <div class="alert alert-info">
                    <h4>Game Status</h4>
                    <p><strong>Current Phase:</strong> 
                        <span class="badge bg-primary">{{ game_state.phase.title() if game_state else 'Not Set' }}</span>
                    </p>
                    
                    {% if game_state and game_state.phase == 'submission' %}
                        <p>Players are currently submitting their number guesses.</p>
                        <form method="POST" action="{{ url_for('advance_phase') }}" class="inline-form">
                            <button type="submit" class="btn btn-warning" 
                                    onclick="return confirm('{% if not players %}No submissions yet. This will skip to draft selection. {% else %}This will calculate results and advance to next phase. {% endif %}Continue?')">
                                {% if not players %}Force Advance to Draft{% else %}Advance to Results{% endif %}
                            </button>
                        </form>
                        {% if players %}
                        <small class="text-muted d-block mt-1">{{ players|length }} submission(s) received</small>
                        {% else %}
                        <small class="text-muted d-block mt-1">No submissions yet - can force advance to draft selection</small>
                        {% endif %}
                    {% elif game_state and game_state.phase == 'results' %}
                        <p>Results calculated. Winner can now select draft position.</p>
                        <form method="POST" action="{{ url_for('advance_phase') }}" class="inline-form">
                            <button type="submit" class="btn btn-success">Advance to Draft Selection</button>
                        </form>
                    {% elif game_state and game_state.phase == 'selecting' %}
                        <p>Draft position selection in progress.</p>
                        <a href="{{ url_for('draft_selection') }}" class="btn btn-primary inline-form-margin-right">View Draft Selection</a>
                        <form method="POST" action="{{ url_for('advance_phase') }}" class="inline-form">
                            <button type="submit" class="btn btn-info">Reset for New Game</button>
                        </form>
                    {% elif game_state and game_state.phase == 'completed' %}
                        <p>Draft order complete! All positions selected.</p>
                        <form method="POST" action="{{ url_for('reset_game') }}" class="inline-form">
                            <button type="submit" class="btn btn-success">Start New Game</button>
                        </form>
                    {% endif %}
                    
                    <!-- Complete Reset (always available) -->
                    <div class="mt-3 pt-2 border-top">
                        <form method="POST" action="{{ url_for('reset_game') }}" class="inline-form">
                            <button type="submit" class="btn btn-outline-danger btn-sm" 
                                    onclick="return confirm('This will delete all data and start completely over. Are you sure?')">
                                ÔøΩÔ∏è Complete Reset
                            </button>
                        </form>
                        <small class="text-muted d-block">Clear all data and start fresh</small>
                    </div>
                </div>

                <!-- Quick Actions for Initialized Games -->
                {% if game_state and game_state.is_initialized %}
                <div class="alert alert-primary">
                    <h4>üéÆ Quick Actions</h4>
                    <div class="row">
                        {% if game_state.is_simulation %}
                        <div class="col-md-4 mb-3">
                            <form method="POST" action="{{ url_for('simulate_game') }}">
                                <button type="submit" class="btn btn-info">
                                    üé≤ Regenerate Players
                                </button>
                            </form>
                            <small class="text-muted">Creates {{ game_state.num_teams }} dummy players</small>
                        </div>
                        <div class="col-md-4 mb-3">
                            <form method="POST" action="{{ url_for('quick_test') }}" class="inline-form">
                                <button type="submit" class="btn btn-outline-success">
                                    üöÄ Quick Test Scenario
                                </button>
                            </form>
                            <small class="text-muted">5 players, pre-calculated winner</small>
                        </div>
                        {% endif %}
                        <div class="col-md-4 mb-3">
                            <form method="POST" action="{{ url_for('admin_toggle_simulation_mode') }}">
                                <button type="submit" class="btn {% if game_state.is_simulation %}btn-success{% else %}btn-info{% endif %}">
                                    {% if game_state.is_simulation %}Switch to Real Mode{% else %}Switch to Simulation{% endif %}
                                </button>
                            </form>
                            <small class="text-muted">Current: {% if game_state.is_simulation %}Simulation{% else %}Real Draft{% endif %}</small>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- League Member Management -->
                {% if game_state and game_state.is_initialized %}
                <div class="alert alert-warning">
                    <h4>üë• League Member Management</h4>
                    <p>Upload a CSV file with league member names to enable dropdown selection:</p>
                    
                    <!-- CSV Upload Form -->
                    <form method="POST" action="{{ url_for('upload_league_members') }}" enctype="multipart/form-data" class="mb-3">
                        <div class="row align-items-end">
                            <div class="col-md-6">
                                <label for="csv_file" class="form-label">CSV File</label>
                                <input type="file" name="csv_file" id="csv_file" class="form-control" accept=".csv" required>
                                <small class="text-muted">CSV should have a 'name' column with league member names</small>
                            </div>
                            <div class="col-md-3">
                                <button type="submit" class="btn" style="background-color: var(--bears-orange); border-color: var(--bears-orange); color: white;">Upload Names</button>
                            </div>
                            <div class="col-md-3">
                                <form method="POST" action="{{ url_for('clear_league_members') }}" class="d-inline">
                                    <button type="submit" class="btn btn-outline-danger btn-sm" 
                                            onclick="return confirm('Clear all league member names?')">
                                        Clear All Names
                                    </button>
                                </form>
                            </div>
                        </div>
                    </form>
                    
                    <!-- Current League Members -->
                    {% if league_members %}
                    <div class="mt-3">
                        <h6>Current League Members ({{ league_members|length }}):</h6>
                        <div class="row">
                            {% for member in league_members %}
                            <div class="col-md-3 mb-1">
                                <span class="badge" style="background-color: var(--bears-navy); color: white;">{{ member.name }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% else %}
                    <div class="mt-3">
                        <small class="text-muted">No league members uploaded yet. Players will use free text input.</small>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                <!-- Backup Management -->
                <div class="alert alert-secondary">
                    <h4>üíæ Backup Management</h4>
                    <p>Automatic backups are created after every submission and phase change.</p>
                    <div class="row">
                        <div class="col-md-6">
                            <form method="POST" action="{{ url_for('create_manual_backup') }}" class="inline-form">
                                <button type="submit" class="btn btn-secondary">
                                    Create Manual Backup
                                </button>
                            </form>
                        </div>
                        <div class="col-md-6">
                            <a href="{{ url_for('list_backups') }}" class="btn btn-outline-secondary">
                                View All Backups
                            </a>
                        </div>
                    </div>
                    <small class="form-text text-muted">Backups are stored locally and include both database and JSON exports</small>
                </div>

                <!-- Manual Player Addition (for late arrivals) -->
                {% if game_state and game_state.phase in ['selecting', 'results'] %}
                <div class="alert alert-info">
                    <h4>‚ûï Add Late Player</h4>
                    <p>Add players who missed the submission deadline directly to draft selection:</p>
                    <form method="POST" action="{{ url_for('add_player_to_draft') }}">
                        <div class="row">
                            <div class="col-md-4">
                                <input type="text" name="player_name" class="form-control" 
                                       placeholder="Player Name" required>
                            </div>
                            <div class="col-md-4">
                                <input type="email" name="player_email" class="form-control" 
                                       placeholder="Email Address" required>
                            </div>
                            <div class="col-md-4">
                                <button type="submit" class="btn btn-info">Add Player to Draft</button>
                            </div>
                        </div>
                    </form>
                    <small class="form-text text-muted">Players added this way won't have participated in the number guessing game</small>
                </div>
                {% endif %}

                <!-- Statistics -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">Total Submissions</h5>
                                <h3 class="text-primary">{{ players|length }}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">Average Guess</h5>
                                <h3 class="text-info">{{ "%.1f"|format(average) if average else "N/A" }}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">Target (2/3 √ó Avg)</h5>
                                <h3 class="text-warning">{{ "%.2f"|format(target) if target else "N/A" }}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">Winner</h5>
                                <h3 class="text-success">{{ winner.name if winner else "TBD" }}</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Submissions Table -->
                {% if players %}
                <h4>All Submissions</h4>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Guess</th>
                                <th>Difference from Target</th>
                                <th>Timestamp</th>
                                <th>IP Address</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for player in players %}
                            <tr {% if winner and player.id == winner.id %}class="table-success"{% endif %}>
                                <td>
                                    {{ player.name }}
                                    {% if winner and player.id == winner.id %}
                                        <span class="badge bg-success">WINNER</span>
                                    {% endif %}
                                </td>
                                <td>{{ player.email }}</td>
                                <td><strong>{{ player.guess }}</strong></td>
                                <td>
                                    {% if target %}
                                        {{ "%.2f"|format(abs(player.guess - target)) }}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                                <td>{{ player.timestamp.strftime('%m/%d %I:%M %p') }}</td>
                                <td>
                                    {% if player.ip_address %}
                                        {% if ip_counts.get(player.ip_address, 0) > 1 %}
                                            <span class="text-warning fw-bold" title="Multiple submissions from this IP">‚ö†Ô∏è {{ player.ip_address }}</span>
                                        {% else %}
                                            {{ player.ip_address }}
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if player.draft_position %}
                                        <span class="badge bg-info">Draft Pos: {{ player.draft_position }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Pending</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-danger" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#deleteModal{{ player.id }}">
                                        üóëÔ∏è Delete
                                    </button>
                                    
                                    <!-- Delete Modal -->
                                    <div class="modal fade" id="deleteModal{{ player.id }}" tabindex="-1">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title">Delete Submission</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                                </div>
                                                <form method="POST" action="{{ url_for('delete_submission', player_id=player.id) }}">
                                                    <div class="modal-body">
                                                        <p>Are you sure you want to delete <strong>{{ player.name }}'s</strong> submission?</p>
                                                        <p><strong>Guess:</strong> {{ player.guess }}</p>
                                                        <div class="mb-3">
                                                            <label for="reason{{ player.id }}" class="form-label">Reason for deletion:</label>
                                                            <input type="text" class="form-control" id="reason{{ player.id }}" name="reason" 
                                                                   placeholder="e.g., Duplicate submission, Wrong email, etc.">
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                        <button type="submit" class="btn btn-danger">Delete Submission</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-secondary">
                    <h4>No submissions yet</h4>
                    <p>Share the main page link with your league members to start collecting guesses.</p>
                    <p><strong>Game URL:</strong> <code>http://localhost:5001</code></p>
                </div>
                {% endif %}
                
                <!-- Deleted Submissions -->
                {% if deleted_players %}
                <div class="mt-4">
                    <h4>üóëÔ∏è Deleted Submissions Log</h4>
                    <div class="table-responsive">
                        <table class="table table-striped table-sm">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Guess</th>
                                    <th>Original Time</th>
                                    <th>IP Address</th>
                                    <th>Deleted Time</th>
                                    <th>Reason</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for deleted in deleted_players %}
                                <tr class="table-warning">
                                    <td>{{ deleted.name }}</td>
                                    <td>{{ deleted.email }}</td>
                                    <td>{{ deleted.guess }}</td>
                                    <td>{{ deleted.original_timestamp.strftime('%m/%d %I:%M %p') }}</td>
                                    <td>
                                        {% if deleted.ip_address %}
                                            {{ deleted.ip_address }}
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ deleted.deleted_timestamp.strftime('%m/%d %I:%M %p') }}</td>
                                    <td>
                                        <small>{{ deleted.deleted_reason or 'No reason provided' }}</small>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}