{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header text-white d-flex justify-content-between align-items-center" style="background-color: var(--bears-navy);">
                <h2 class="mb-0">üíæ Backup Management</h2>
                <div>
                    <form method="POST" action="{{ url_for('create_manual_backup') }}" class="inline-form">
                        <button type="submit" class="btn btn-outline-light btn-sm">Create Backup</button>
                    </form>
                    <a href="{{ url_for('admin') }}" class="btn btn-outline-light btn-sm">Back to Admin</a>
                </div>
            </div>
            <div class="card-body">
                {% if backups %}
                <p><strong>{{ backups|length }}</strong> backup(s) available. Backups are automatically created after every submission and phase change.</p>
                
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead style="background-color: var(--bears-navy); color: white;">
                            <tr>
                                <th>Date & Time</th>
                                <th>Reason</th>
                                <th>Size</th>
                                <th>Filename</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for backup in backups %}
                            <tr>
                                <td>{{ backup.display_date }}</td>
                                <td>
                                    <span class="badge {% if backup.reason == 'submission' %}bg-primary{% elif backup.reason == 'phase_advance' %}{% elif backup.reason == 'manual' %}bg-secondary{% else %}bg-info{% endif %}" 
                                          {% if backup.reason == 'phase_advance' %}style="background-color: var(--bears-orange) !important;"{% endif %}>
                                        {{ backup.reason.title() }}
                                    </span>
                                </td>
                                <td>{{ "%.1f"|format(backup.size / 1024) }} KB</td>
                                <td><code>{{ backup.filename }}</code></td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <form method="POST" action="{{ url_for('restore_from_backup', backup_filename=backup.filename) }}" class="inline-form">
                                            <button type="submit" class="btn btn-warning btn-sm" 
                                                    onclick="return confirm('Are you sure you want to restore from this backup? Current data will be backed up first.')">
                                                Restore
                                            </button>
                                        </form>
                                        <form method="POST" action="{{ url_for('delete_backup_file', backup_filename=backup.filename) }}" class="inline-form">
                                            <button type="submit" class="btn btn-danger btn-sm" 
                                                    onclick="return confirm('Are you sure you want to delete this backup? This cannot be undone.')">
                                                Delete
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <div class="alert alert-warning mt-4">
                    <h5>‚ö†Ô∏è Important Backup Information</h5>
                    <ul class="mb-0">
                        <li><strong>Automatic Backups:</strong> Created after every submission and phase change</li>
                        <li><strong>Storage:</strong> Backups are kept as both SQLite database files and JSON exports</li>
                        <li><strong>Retention:</strong> Only the last 50 backups are kept (older ones auto-deleted)</li>
                        <li><strong>Restore Process:</strong> Current data is backed up before restore (as "pre_restore")</li>
                        <li><strong>JSON Export:</strong> Each backup includes a human-readable JSON export for inspection</li>
                    </ul>
                </div>
                
                {% else %}
                <div class="alert alert-info">
                    <h4>No Backups Found</h4>
                    <p>No backups are currently available. Backups will be created automatically when:</p>
                    <ul>
                        <li>Players submit their guesses</li>
                        <li>Game phases are advanced</li>
                        <li>Manual backups are created</li>
                    </ul>
                    <form method="POST" action="{{ url_for('create_manual_backup') }}">
                        <button type="submit" class="btn" style="background-color: var(--bears-orange); border-color: var(--bears-orange); color: white;">Create First Backup</button>
                    </form>
                </div>
                {% endif %}
                
                <div class="mt-4">
                    <h5>Backup Types</h5>
                    <div class="row">
                        <div class="col-md-3">
                            <span class="badge bg-primary">Submission</span> - After each player guess
                        </div>
                        <div class="col-md-3">
                            <span class="badge" style="background-color: var(--bears-orange);">Phase Advance</span> - When game phase changes
                        </div>
                        <div class="col-md-3">
                            <span class="badge bg-secondary">Manual</span> - Manually created backup
                        </div>
                        <div class="col-md-3">
                            <span class="badge bg-info">Pre Restore</span> - Before restoring backup
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
